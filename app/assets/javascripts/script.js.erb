$(document).ready(function() {
  $('.menu-dropdown').dropdown();

  /*
    To simulate the group loan product
      In the form:
        #weekly_principal
        #weekly_interest
        #duration
    
      In the calculator 
        #total_principal
        #percentage_interest
        #calculator_duration
  */

  $("#simulate_group_loan_product").click(function(){/*
      console.log("I am fucking clicked");
      console.log("Total principal is " + parseFloat( $("#total_principal input").val()  ) );
      console.log("Total percentage is " + parseFloat( $("#percentage_interest input").val()  ) );
      console.log("Total duration is " + parseInt(  $("#calculator_duration input").val()  ));*/
    
    var total_principal = parseFloat( $("#total_principal input").val()  );
    var percentage_interest = parseFloat( $("#percentage_interest input").val()  );
    var loan_duration =  parseInt(  $("#calculator_duration input").val() );
    
    var weekly_principal = total_principal/loan_duration; 
    var weekly_interest = weekly_principal * percentage_interest/100;
    /*
        console.log("the calculated weekly principal is " + weekly_principal);
        console.log("The calculated weekly interest is "+ weekly_interest);*/
    $("#weekly_principal").val(weekly_principal);
    $("#weekly_interest").val( weekly_interest );
    $("#duration").val( loan_duration );
  });
  
  // assignment related methods 
   $(".checkbox_tracker").change( function(){
     var $checkbox = $(this);
     var after_clicked_value;

     /*
       Extracting the value of the checkbox, based on the user action
     */
     if(   $checkbox.is(":checked")  ) {
       $checkbox.attr('value', <%= TRUE_CHECK %>);
       after_clicked_value = <%= TRUE_CHECK %>;
     }else{
       $checkbox.attr( 'value', <%= FALSE_CHECK %> );
        after_clicked_value = <%= FALSE_CHECK %>;
     }


     var checkbox_id = $checkbox.attr("id");
     var provider_id = checkbox_id.split("-")[0].split("_")[1];
     var consumer_id = checkbox_id.split("-")[1].split("_")[1];

     var $form = $("#checkbox_form_wrapper form");

     var provider_field = $("#membership_provider");
     provider_field.attr('value', provider_id);
     var consumer_field = $("#membership_consumer");
     consumer_field.attr('value', consumer_id);

     var decision_field = $("#membership_decision");
     decision_field.attr("value", after_clicked_value )

     if($checkbox.hasClass("single-submit")){
       $form.trigger('submit');
     }else {


       $checkbox.showLoading();

       $.ajax({
         url: $form.attr("action"),
         type: "POST",
         data: $form.serialize(),
         dataType: 'script',
         success: function(response){

           $form.clearForm();
           $checkbox.hideLoading();
         }
       });
     }
   });
   
   /*
   See details of group_loan_product
   */
   $("a.group_loan_product_details").live('click', function(){
     var modal_id = $(this).attr("id").split("-")[1];
     
     var $modal_wrapper = $("#myModal-" + modal_id );
     $modal_wrapper.modal('show');
     var $modal_closer = $(".modal-footer .modal-closer", $modal_wrapper);
     $modal_closer.click(function(){
       $modal_wrapper.modal('hide');
       return false;
     });
     
     return false; 
     
     /*
     For modal size, use https://github.com/twitter/bootstrap/issues/675
     */
   });
   
   
   /*
    To assign group loan, change group loan 
   */
   $(".change_group_loan_product").live("click", function(){
     var $this = $(this);
     
     var group_membership_id;
     var member_group_loan_product_id; 
     
     var $assign_loan_modal = $("#myModal-loan_product_selector");
     var $modal_closer = $(".modal-footer .modal-closer", $assign_loan_modal );
     var $summary_page = $(".summary_product_selector", $assign_loan_modal);
     var $back_to_summary_button = $(".back_to_summary_button", $assign_loan_modal);
     
     // Show the summary page
     $summary_page.removeClass("modal-hidden");
     
     // hide all detail pages
     $(".detail_product_page", $assign_loan_modal).each(function(){
       $(this).addClass("modal-hidden");
     });
     // hide the back to summary button
     $back_to_summary_button.hide();
     
     // unbind the select button
     $(".group_loan_product_select", $assign_loan_modal).each(function(){
       $(this).unbind();
     });
     
     // unbind the details button
     $(".group_loan_product_details_selector", $assign_loan_modal).each(function(){
       $(this).unbind();
     });
     
     
     
     if( $this.hasClass("no_loan_assigned") ){
       group_membership_id = $(this).attr("id").split("-")[1];
       member_group_loan_product_id = 0 ;
     }else{
       group_membership_id = $(this).attr("id").split("_")[0].split("-")[1];
       member_group_loan_product_id = $(this).attr("id").split("_")[1].split("-")[1];
     }
    
     
     // bind the detail button 
     $(".group_loan_product_details_selector", $assign_loan_modal).click(function(){
       var product_detail_id = $(this).attr("id").split("-")[1];
       $summary_page.addClass("modal-hidden");
       var $detail_product_page = $("#detail_product_page-" + product_detail_id);
       $detail_product_page.removeClass("modal-hidden");
       
       $back_to_summary_button.show();
       // bind the back button
       $back_to_summary_button.click(function(){
         $(this).hide();
         $detail_product_page.addClass("modal-hidden");
         $summary_page.removeClass("modal-hidden");
       });
     });
     
     
     // bind the select button 
     $(".group_loan_product_select", $assign_loan_modal).each(function(){
       
       var group_loan_product_id = $(this).attr("id").split("-")[1];
       if( group_loan_product_id == member_group_loan_product_id){
         $(this).addClass("btn-success"); 
         $(this).text("Selected");
       }else{
         $(this).removeClass("btn-success");
         $(this).text("Select");
         $(this).click(function(){
            $assign_loan_modal.showLoading();
            
            var $form = $("#checkbox_form_wrapper form" );
            var $membership_provider = $("#membership_provider");
            $membership_provider.attr('value', group_loan_product_id );
            var $membership_consumer = $("#membership_consumer");
            $membership_consumer.attr('value', group_membership_id );
            
            // $assign_loan_modal.hideLoading();
            
            $.ajax({
              url: $form.attr("action"),
              type: "POST",
              data: $form.serialize(),
              dataType: 'script',
              success: function(response){
                $form.clearForm();
                $assign_loan_modal.hideLoading();
              }
            });
          });
       }
     });
     
     $modal_closer.click(function(){
       $assign_loan_modal.modal('hide');
       return false;
     });
     $assign_loan_modal.modal("show");
     
     return false;
   });
   
   
   /*
     Approval Button
   */
});



$.fn.clearForm = function() {
  return this.each(function() {
    var type = this.type, tag = this.tagName.toLowerCase();
    if (tag == 'form')
      return $(':input',this).clearForm();
    if (type == 'text' || type == 'password' || tag == 'textarea')
      this.value = '';
    else if (type == 'checkbox' || type == 'radio')
      this.checked = false;
    else if (tag == 'select')
      this.selectedIndex = -1;
  });
};

function action_error(text){
  alert(text);
}

// <div class="modal" id="myModal" style="display:none;">
//    <div class="modal-header">
//      <a class="close" data-dismiss="modal">×</a>
//      <h3>Modal header</h3>
//    </div>
//    <div class="modal-body">
//      <p>One fine body…</p>
//    </div>
//    <div class="modal-footer">
//      <a href="#" class="btn modal-closer">Close</a>
//      <!-- <a href="#" class="btn btn-primary">Save changes</a> -->
//    </div>
//  </div>
//  

function summonModal(header_text, body_text, modal_id){
  var $modal_wrapper = $("#" + modal_id); 
  var $header = $(".modal-header h3", $modal_wrapper);
  var $body  = $(".modal-body p", $modal_wrapper);
  var $modal_closer = $(".modal-footer .modal-closer ", $modal_wrapper);
  // setting the header text
  $header.text( header_text );
  $body.text( body_text );
  
  $modal_wrapper.modal('show');
  
  $modal_closer.click(function(){
    // console.log("Oh yeah baby, closed");
    $modal_wrapper.modal('hide');
  });
  
}

function reverseCheckbox( checkbox_id ){
  var $checkbox = $("#" + checkbox_id );
  
  if(   $checkbox.is(":checked")  ) {
     $checkbox.attr('value', <%= FALSE_CHECK %>);
     $checkbox.attr('checked', false);
   }else{
     $checkbox.attr( 'value', <%= TRUE_CHECK %> );
     $checkbox.attr('checked', true);
   }
}

function fillCheckbox( checkbox_id, value  ){
  var $checkbox = $("#" + checkbox_id );
  
  if( value == 1 ) {
    // true  
    $checkbox.attr('value', <%= TRUE_CHECK %>);
    $checkbox.attr('checked', true );
  }else if( value == 0 ){
    //false 
    $checkbox.attr('value', <%= FALSE_CHECK %>);
    $checkbox.attr('checked', false );
  }
 
}