
<div class="span9 content">
  <%= create_guide("Group Loan Setup", 
        "Setup group loan for office: <b>#{@office.name}</b>" + "<br />" + 
        "Total  Member: <b>#{@group_loan_memberships.count}</b> " + "<br />"+ 
        "Lokasi: <b>#{@group_loan.get_commune}</b>").html_safe %>
  
  <%#= create_breadcrumb(@breadcrumbs).html_safe %>
  
  
  <!-- <div class="alert alert-info" style="text-align:center;">
    <a data-dismiss="alert" class="close">×</a>
    <strong>Hello!!</strong> Anda (loan officer) harus mengumpulkan biaya setup untuk Group Loan. <br />
    Adapun komponen biaya setup itu adalah: <strong>Admin Fee</strong>, 
    <strong>Tabungan Awal</strong>, dan <strong>Deposito</strong>. <br />
    Jika <strong>semua member</strong> telah membayar biaya setup, maka click tombol berikut ini:
    <br >
    <p style="text-align:center; margin-top:30px;">
    <button href="#" class="btn btn-primary">Finalize Setup</button>
    </p>
  </div>
         -->
        
  
   
  <div class="row-fluid">
    <div id="data_list">
      <table cellpadding="0" cellspacing="0" border="0" 
            class="table table-striped table-bordered" id="example">
        <thead>
          <tr>
            <th>Nama</th>
            <th>Admin Fee</th>
            <th>Initial Saving</th>
            <th>Deposit</th>
            <th style="text-align:center;" colspan="2">Action</th> 
            
          </tr>
        </thead>
        <tbody>
          <% @group_loan_memberships.each do |group_loan_membership| %>
            <%= render :partial => "group_loan_memberships/setup_payment", 
                    :locals => {:group_loan_membership => group_loan_membership }%>
          <% end %>
       
        </tbody>
      </table>
      
    </div><!-- end of #data_list -->
  </div>
  
  <div class=" hidden" id="data_form_wrapper">
    
  </div>
  
  
</div><!--/span-->


<div class="modal" id="myModal" style="display:none;">
  
  
  <div class="modal-header">
    <a class="close" data-dismiss="modal">×</a>
    <h3></h3>
  </div>
  
  <%= render :partial => "transaction_activities/setup_payment/form_modal_body" %>
  <%= render :partial => "transaction_activities/setup_payment/notification_modal_body" %>
  
  <div class="modal-footer">
    <a href="#" class="btn modal-closer">Close</a>
    <a href="#" class="btn btn-primary execute_transaction">Execute Transaction</a>
  </div>
</div>


<div class="hidden" id="form_setup_payment_wrapper">
  
  
  
</div>
 
 

<% content_for :additional_js  do %>
  <script type="text/javascript">
    $(document).ready(function(){
      $(".setup_payment").live('click', function(){
        // console.log("first click");
      
        var $this = $(this);
        var $form = $("#pay_setup_fee_form");
        var $row_wrapper = $this.parents("tr");
        var row_id_prefix = $row_wrapper.attr("id").split("-")[0];
        var current_row_id = $row_wrapper.attr("id").split("-")[1];
        
        var $modal_wrapper = $("#myModal"); 
        var $header = $(".modal-header", $modal_wrapper);
        var $body  = $("#form_body", $modal_wrapper);
        var $modal_closer = $(".modal-footer .modal-closer ", $modal_wrapper);
        var $modal_exe = $(".modal-footer .execute_transaction");
        
        
        
        
        var member_name =  $(".member_name", $row_wrapper).text()  ;
        var admin_fee = newParseInt( $(".admin_fee", $row_wrapper).attr("value") );
        var min_initial_savings = newParseInt(  $(".initial_savings" , $row_wrapper).attr("value") );
        
        var header_html = "Setup Payment for <b>"+ member_name + "</b>";
        $("#admin_fee").attr('value', admin_fee);
        $("#initial_savings").attr("value", min_initial_savings);
        $("#admin_fee_uneditable").text( admin_fee );
        
        var total = admin_fee + min_initial_savings;
        $("#total_setup_payment").text( total );
        
        $header.html( header_html );
        

        $modal_wrapper.modal("show");
        
   

        $modal_closer.click(function(){
          $modal_wrapper.modal('hide');
          $("#deposit").attr("value", '' );
          $modal_exe.show();
          $form.clearForm();
          // hide the notification modal
          $("#notification_modal_body").hide();
          // show the form_modal
          $("#form_body").show();
          return false;
        });


        $modal_exe.click(function(){
          $modal_exe.unbind('click');
          var new_initial_savings = newParseInt( $("#initial_savings").attr("value"));
          var deposit  = newParseInt(  $("#deposit").attr("value"));
          var total_value = admin_fee + new_initial_savings + deposit; 
          
          var errors = [];
          if( deposit < 0 ){
            errors.push("Deposit can't be smaller than 0");
          }
          
          if( new_initial_savings < min_initial_savings){
            errors.push("Initial savings can't be smaller than " + min_initial_savings );
          }
          
          if( errors.length == 0 ) {
            if(  confirm("The total value is " + addCommas(total_value) + ". Are you sure?")  ){
              $modal_wrapper.showLoading();
              $.ajax({
                 url: $form.attr("action"),
                 type: "POST",
                 data: $form.serialize(),
                 dataType: 'script',
                 success: function(response){
                   $modal_wrapper.hideLoading();
                 }
               });
              $modal_exe.show();
            }else{
              $modal_exe.show();
            }
          }else{
            for( var i = 0; i < errors.length; i++){
              alert( errors[i]);
            }
          }
        });
        
        
        return false;
      });
    });
  </script>
<% end %>















